<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="dodbrit RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="dodbrit Atom Feed"><title data-rh="true">K3S Cluster with vSphere Storage (Part III) | dodbrit</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://blog.dodbrit.dev/2021-07-03/k3s-cluster-with-vsphere-storage-part-iii"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="K3S Cluster with vSphere Storage (Part III) | dodbrit"><meta data-rh="true" name="description" content="K3S Cluster with vSphere Storage Hero"><meta data-rh="true" property="og:description" content="K3S Cluster with vSphere Storage Hero"><meta data-rh="true" property="og:image" content="https://blog.dodbrit.dev/k3s_vsphere_part3.png"><meta data-rh="true" name="twitter:image" content="https://blog.dodbrit.dev/k3s_vsphere_part3.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-07-30T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/pkeech"><meta data-rh="true" property="article:tag" content="Rancher,Kubernetes,Storage,K3S,VMWare"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.dodbrit.dev/2021-07-03/k3s-cluster-with-vsphere-storage-part-iii"><link data-rh="true" rel="alternate" href="https://blog.dodbrit.dev/2021-07-03/k3s-cluster-with-vsphere-storage-part-iii" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.dodbrit.dev/2021-07-03/k3s-cluster-with-vsphere-storage-part-iii" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b8533b3d.css">
<link rel="preload" href="/assets/js/runtime~main.4251cab0.js" as="script">
<link rel="preload" href="/assets/js/main.6d0504ee.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="dodbrit logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="dodbrit logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/dodbrit/documentation" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link github-link" aria-label="GitHub"></a><a href="https://www.linkedin.com/in/peter-keech-b88183a2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link linkedin-link" aria-label="LinkedIn"></a><a href="mailto:peter@dodbrit.dev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link email-link" aria-label="email"></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021-10-29/terminating-namespaces">Terminating Namespaces</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021-07-03/k3s-cluster-with-vsphere-storage-part-i">K3S Cluster with vSphere Storage (Part I)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021-07-03/k3s-cluster-with-vsphere-storage-part-ii">K3S Cluster with vSphere Storage (Part II)</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/2021-07-03/k3s-cluster-with-vsphere-storage-part-iii">K3S Cluster with vSphere Storage (Part III)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2021-07-03/k3s-cluster-with-vsphere-storage-part-iv">K3S Cluster with vSphere Storage (Part IV)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://blog.dodbrit.dev/k3s_vsphere_part3.png"><header><h1 class="title_f1Hy" itemprop="headline">K3S Cluster with vSphere Storage (Part III)</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-07-30T00:00:00.000Z" itemprop="datePublished">July 30, 2021</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pkeech" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/pkeech.png" alt="Peter Keech"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pkeech" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Peter Keech</span></a></div><small class="avatar__subtitle" itemprop="description">DevOps Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p><img loading="lazy" alt=" K3S Cluster with vSphere Storage Hero" src="/assets/images/k3s_vsphere_part3-603a59da1b815db7f979bf59aed9111a.png" width="1400" height="933" class="img_ev3q"></p><p>Having followed the steps in Part II, you should have a K3S Cluster stood up. In this Part we are going to add the all important Cloud Provider.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-prepare-nodes-for-vsphere-cloud-provider">Step 1: Prepare Nodes for vSphere Cloud Provider<a class="hash-link" href="#step-1-prepare-nodes-for-vsphere-cloud-provider" title="Direct link to heading">​</a></h2><p>Before we can install the vSphere Cloud provider, there are couple configurations that need to be applied. You can read more about these requirements by heading over to the <a href="https://cloud-provider-vsphere.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">VMWare documentation</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="taint-nodes">Taint Nodes<a class="hash-link" href="#taint-nodes" title="Direct link to heading">​</a></h3><p>The Cloud Provider is going to be installed on the Server (Master) Nodes. To ensure this happens correctly, we need to ensure the nodes are tainted correctly.</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>Not sure if this is a K3S quirk or just my luck, but additionally I had to reapply the Master and Worker roles to the Nodes for the DaemonSet to recognize the Role.</p></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## TAINT SERVER (MASTER) NODES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl taint nodes --selector</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;node-role.kubernetes.io/master&#x27;</span><span class="token plain"> node-role.kubernetes.io/master</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">:NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## ADD ROLES TO SERVER (MASTER) NODES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl label nodes --selector</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;node-role.kubernetes.io/master&#x27;</span><span class="token plain"> node-role.kubernetes.io/master</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> --overwrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## TAINT AGENT (WORKER) NODES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl taint nodes --selector</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;!node-role.kubernetes.io/master&#x27;</span><span class="token plain"> node.cloudprovider.kubernetes.io/uninitialized</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true:NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## ADD ROLES TO AGENT (WORKER) NODES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl label nodes --selector</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;node-role.kubernetes.io/worker&#x27;</span><span class="token plain"> node-role.kubernetes.io/worker</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> --overwrite</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once you have applied the Taints, you can verify they applied successfully by running this command;</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## VALIDATE TAINTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe nodes </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">egrep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Taints:|Name:&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the taints applied successfully you should see all the Server (Master) Nodes with the Taint <code>node-role.kubernetes.io/master:NoSchedule</code> and all Agent (Worker) Nodes have the Taint <code>node.cloudprovider.kubernetes.io/uninitialized=true:NoSchedule</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-virtual-machine-settings">Configure Virtual Machine Settings<a class="hash-link" href="#configure-virtual-machine-settings" title="Direct link to heading">​</a></h3><p>Another configuration item that needs to occur, is ensuring that each virtual machine’s hard disk (vmdk) is assigned a unique identifier (UUID). The easiest way to interact with the virtual machine settings is to use a command line utility called <code>govc</code>.</p><blockquote><p>govc is vSphere CLI provided by VMware and is built on top of govmoi. The CLI is designed to be a user friendly CLI alternative to the GUI and well suited for automation tasks. It also acts as a test harness for the govmomi APIs and provides working examples of how to use the APIs.</p><p>– <a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener noreferrer"><em>Govc Github</em></a></p></blockquote><p>To install the CLI on Mac, you can use Homebrew. To install govc run <code>brew install govc</code>. For other operating systems, please refer to the <a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener noreferrer">documentation</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="govc-setup">GOVC Setup<a class="hash-link" href="#govc-setup" title="Direct link to heading">​</a></h3><p>Before we can use the utility we have to specify how <code>govc</code> connects to vSphere. In Mac and Linux, this is accomplished by setting environment variables.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## CONFIGURE GOVC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GOVC_URL</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;{{ URL-FOR-VCSA }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GOVC_USERNAME</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;administrator@vsphere.local&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GOVC_PASSWORD</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;{{ PASSWORD-FOR-ABOVE-ACCOUNT }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">GOVC_INSECURE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th><strong>Variable</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>GOVC_URL</td><td>the URL for your vSphere (VCSA) instance</td></tr><tr><td>GOVC_USERNAME</td><td>the login account for vSphere</td></tr><tr><td>GOVC_PASSWORD</td><td>the password for the account specified</td></tr><tr><td>GOVC_INSECURE</td><td>used when self-signed certificates are in use on VCSA, suppresses certificate warnings</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enable-diskuuid">Enable DiskUUID<a class="hash-link" href="#enable-diskuuid" title="Direct link to heading">​</a></h3><p>At this point you should be able to utilize <code>govc</code> to query vSphere. The first command you can run is <code>govc ls</code>. This will list the any DataCenters you have configured and folders. You will need to enable DiskUUID on all the virtual machines in the cluster and to do this you will need to know the path to the virtual machine.</p><p>To find the path use the <code>govc ls</code> command followed by a path. Start with leaving it blank and keep drilling down until you find the paths to your virtual machines. For the example below, my final govc command looked like; <code>govc ls /Homelab/vm/Applications/Demo/</code></p><p>Enable DiskUUID on the virtual machines by running the following command. Outline below is how I applied it in my stack.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## ADD DISK UUID FLAG</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">govc vm.change -e</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disk.enableUUID=1&quot;</span><span class="token plain"> -vm</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;{{ PATH-TO-VM }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## EXAMPLE -- ADD DISK UUID </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">govc vm.change -e</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disk.enableUUID=1&quot;</span><span class="token plain"> -vm</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;/Homelab/vm/Applications/Demo/MASTER-001&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">govc vm.change -e</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disk.enableUUID=1&quot;</span><span class="token plain"> -vm</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;/Homelab/vm/Applications/Demo/MASTER-002&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">govc vm.change -e</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disk.enableUUID=1&quot;</span><span class="token plain"> -vm</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;/Homelab/vm/Applications/Demo/MASTER-003&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">govc vm.change -e</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disk.enableUUID=1&quot;</span><span class="token plain"> -vm</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;/Homelab/vm/Applications/Demo/WORKER-001&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">govc vm.change -e</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disk.enableUUID=1&quot;</span><span class="token plain"> -vm</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;/Homelab/vm/Applications/Demo/WORKER-002&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">govc vm.change -e</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;disk.enableUUID=1&quot;</span><span class="token plain"> -vm</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;/Homelab/vm/Applications/Demo/WORKER-003&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-providerid">Adding ProviderID<a class="hash-link" href="#adding-providerid" title="Direct link to heading">​</a></h3><p>The final configuration change needed is to add a “ProviderID” to each of the nodes. Reading though the documentation, this ID needs to be unique but can be set to anything (within reason). Borrowing from the documentation, the easiest thing to do is to assign the virtual machine UUID as the ProviderID as these are always unique.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## ADD PROVIDERID TO EACH NODE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">vm</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">govc </span><span class="token variable function" style="color:#d73a49">ls</span><span class="token variable" style="color:#36acaa"> /Homelab/vm/Applications/Demo/</span><span class="token variable" style="color:#36acaa">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">MACHINE_INFO</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">govc vm.info -json -dc</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">Homelab -vm.ipath</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$vm</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> -e</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">true</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">VM_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">jq -r </span><span class="token variable string" style="color:#e3116c">&#x27; .VirtualMachines[] | .Name&#x27;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">&lt;&lt;&lt;</span><span class="token variable" style="color:#36acaa"> $MACHINE_INFO </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{print tolower($0)}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">VM_UUID</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa"> jq -r </span><span class="token variable string" style="color:#e3116c">&#x27; .VirtualMachines[] | .Config.Uuid&#x27;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">&lt;&lt;&lt;</span><span class="token variable" style="color:#36acaa"> $MACHINE_INFO </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{print toupper($0)}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$VM_NAME</span><span class="token plain">.dodbrit.lab -p </span><span class="token string" style="color:#e3116c">&quot;{</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">spec</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">:{</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">providerID</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">:</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">vsphere://</span><span class="token string variable" style="color:#36acaa">$VM_UUID</span><span class="token string entity" style="color:#36acaa">\&quot;</span><span class="token string" style="color:#e3116c">}}&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For good measure, you can validate that the ProviderIDs were added correctly by running <code>kubectl describe nodes | egrep &quot;ProviderID:|Name:&quot;</code>. The expected outcome should be all of the nodes listed, with a ProviderID that starts with “vsphere”. Additionally, the IDs should all be unique.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-install-vsphere-cpi">Step 2: Install vSphere CPI<a class="hash-link" href="#step-2-install-vsphere-cpi" title="Direct link to heading">​</a></h2><p>Now that we have our cluster up and running, and the nodes configured with additional information, we can finally install the vSphere Cloud Provider.</p><p>The first step is generate the required configuration file (<code>vsphere.conf</code>) and credentials (<code>cpi-secret.yaml</code>).</p><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">vsphere.conf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># vsphere.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Global properties in this section will be used for all specified vCenters unless overriden in VirtualCenter section.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">global:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # default https port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  port: 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # set insecureFlag to true if the vCenter uses a self-signed cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  insecureFlag: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # settings for using k8s secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secretName: cpi-global-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secretNamespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># vcenter section</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vcenter:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # arbitrary name for cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  demo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ip or fqdn of vcsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server: 10.0.15.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # vSphere Datacenter Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    datacenters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - Homelab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # secret with credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secretName: cpi-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secretNamespace: kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">cpi-secret.yaml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># cpi-secret.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cpi</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">stringData</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">10.0.15.5.username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;administrator@vsphere.local&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">10.0.15.5.password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{ PASSWORD-TO-ACCOUNT }}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To apply the vSphere configuration to the cluster, we will create a ConfigMap of the file. To do that you run the following command;</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create configmap cloud-config --from-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vsphere.conf --namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will create a ConfigMap in the <code>kube-system</code> namespace with all the items we defined. To add the login credentials, we just need to apply the Secret as that was defined as a Secret to begin with.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f cpi-secret.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Again for peace of mind, we can validate these applied;</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## ENSURE CONFIGMAP WAS CREATED</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get configmap cloud-config --namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## ENSURE SECRET WAS CREATED</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secret cpi-secret --namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After you have verified that the ConfigMap and Secret was created, you can delete both of these files. These files have potentially sensitive information in them and its good practice to remove them.</p><p>Now we can deploy all the components of the vSphere Cloud Provider. We are going to apply them directly from the vSphere GitHub repository.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>It is recommend that you review the files first and once you feel confident that the files are safe, you can then apply them</p></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## CREATE ROLES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes/cloud-provider-vsphere/master/manifests/controller-manager/cloud-controller-manager-roles.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## CREATE ROLE BINDINGS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes/cloud-provider-vsphere/master/manifests/controller-manager/cloud-controller-manager-role-bindings.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## CREATE DAMEONSET</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://github.com/kubernetes/cloud-provider-vsphere/raw/master/manifests/controller-manager/vsphere-cloud-controller-manager-ds.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And we can check that the Cloud Provider deployed successfully. You should see a <strong>vsphere-cloud-controller-manager</strong> running on each of your master nodes.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --all-namespaces</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Congratulations! We have just install the vSphere Cloud Provider within our cluster!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-install-vsphere-csi">Step 3: Install vSphere CSI<a class="hash-link" href="#step-3-install-vsphere-csi" title="Direct link to heading">​</a></h2><p>Now that the Cloud Provider has been installed, we can turn the attention to the Cloud Storage Interface (CSI). Just like the Cloud Provider, we need to create some configuration files. Modify the file outlined below and save it as <code>csi-vsphere.conf</code>.</p><div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">csi-vsphere.conf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Global]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-id = &quot;k3s-cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user = &quot;administrator@vsphere.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">password = &quot;{{ PASSWORD-FOR-ACCOUNT }}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port = &quot;443&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">insecure-flag = &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[VirtualCenter &quot;{{ VCSA-IP-ADDRESS }}&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datacenters = &quot;Homelab&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Workspace]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server = &quot;{{ VCSA-IP-ADDRESS }}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">datacenter = &quot;Homelab&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default-datastore = &quot;{{ DEFAULT-VSPHERE-DATASTORE }}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resourcepool-path = &quot;{{ DATACENTER-NAME }}/Resources&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">folder = &quot;kubernetes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Disk]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scsicontrollertype = pvscsi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The default-datastore field in the configuration file is important enough that it is included in the file, but will not be used once we configure the Storage Class. The Storage Class grants us the ability to define where the persistent storage will be save. Additionally, multiple Storage Class‘s can be defined that will allow for more granular storage based upon the deployment.</p><p>Unlike CPI, we are going to upload this configuration to Kubernetes via a Secret.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret generic vsphere-config-secret --from-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">csi-vsphere.conf --namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When then validate that the Secret created successfully …</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secret vsphere-config-secret --namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>At this point, you made delete csi-vsphere.conf as it contains sensitive information.</p></div></div><p>Now we can deploy all the components of the vSphere Storage Provider. We are going to apply them directly from the vSphere GitHub repository.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## DEFINE CLUSTER ROLES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/vsphere-csi-driver/v2.2.0/manifests/v2.2.0/rbac/vsphere-csi-controller-rbac.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## DEFINE ROLE BINDINGS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/vsphere-csi-driver/v2.2.0/manifests/v2.2.0/rbac/vsphere-csi-node-rbac.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## DEPLOY STORAGE DRIVERS (CONTROLLER)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/vsphere-csi-driver/v2.2.0/manifests/v2.2.0/deploy/vsphere-csi-controller-deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## DEPLOY STORAGE DRIVERS (DAMEONSET)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/vsphere-csi-driver/v2.2.0/manifests/v2.2.0/deploy/vsphere-csi-node-ds.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then validate the installation by checking the Pod deployment. It may take a few minutes for all of the pods to get created and start running.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>At this point, and ensuring that everything went smoothly, you should have a Kubernetes cluster running with both vSphere CPI and CSI running and configured. In Part IV of this blog, we are going to define the storage class within the cluster and deploy a demo application.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">​</a></h2><ul><li><a href="https://longhorn.io/" target="_blank" rel="noopener noreferrer">Rancher Labs Longhorn</a></li><li><a href="https://cloud-provider-vsphere.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">vSphere Cloud Provider</a></li><li><a href="https://vsphere-csi-driver.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">vSphere Storage Provider</a></li><li><a href="https://rancher.com/docs/k3s/latest/en/" target="_blank" rel="noopener noreferrer">Rancher Labs K3S</a></li><li><a href="https://kubernetes.io/docs/concepts/architecture/cloud-controller/" target="_blank" rel="noopener noreferrer">Kuberenetes Cloud Controllers</a></li><li><a href="https://vmware.github.io/photon/docs/" target="_blank" rel="noopener noreferrer">VMware Photon OS</a></li><li><a href="http://nginx.org/en/docs/http/load_balancing.html" target="_blank" rel="noopener noreferrer">NGINX Load Balancer</a></li><li><a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener noreferrer">Govc Documentation</a></li></ul></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/rancher">Rancher</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/kubernetes">Kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/storage">Storage</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/k-3-s">K3S</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/vm-ware">VMWare</a></li></ul></div></footer></article><div id="disqus_thread"></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2021-07-03/k3s-cluster-with-vsphere-storage-part-ii"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">K3S Cluster with vSphere Storage (Part II)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2021-07-03/k3s-cluster-with-vsphere-storage-part-iv"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">K3S Cluster with vSphere Storage (Part IV)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#step-1-prepare-nodes-for-vsphere-cloud-provider" class="table-of-contents__link toc-highlight">Step 1: Prepare Nodes for vSphere Cloud Provider</a><ul><li><a href="#taint-nodes" class="table-of-contents__link toc-highlight">Taint Nodes</a></li><li><a href="#configure-virtual-machine-settings" class="table-of-contents__link toc-highlight">Configure Virtual Machine Settings</a></li><li><a href="#govc-setup" class="table-of-contents__link toc-highlight">GOVC Setup</a></li><li><a href="#enable-diskuuid" class="table-of-contents__link toc-highlight">Enable DiskUUID</a></li><li><a href="#adding-providerid" class="table-of-contents__link toc-highlight">Adding ProviderID</a></li></ul></li><li><a href="#step-2-install-vsphere-cpi" class="table-of-contents__link toc-highlight">Step 2: Install vSphere CPI</a></li><li><a href="#step-3-install-vsphere-csi" class="table-of-contents__link toc-highlight">Step 3: Install vSphere CSI</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 <br><i>Posts have been created from personal experiences working on personal and professional projects and have not been influenced by any vendor. Built with Docusaurus.</i></div></div></div></footer></div>
<script src="/assets/js/runtime~main.4251cab0.js"></script>
<script src="/assets/js/main.6d0504ee.js"></script>
</body>
</html>